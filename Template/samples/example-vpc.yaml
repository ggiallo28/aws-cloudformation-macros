Transform: [Template]
Description: Example Macro Template.

Parameters:
  ProjectName:
    Type: String
    Default: xp-coast/xpeppers/xpeppers-cloudformation-sample
  BranchName:
    Type: String
    Default: master
  TemplateVPC:
    Type: String
    Default: vpc/vpc.yml
  TemplateFlowLog:
    Type: String
    Default: flowlog-crr/flowlog.yml
  GitLabToken:
    Type: String
    Default: vLy_f4quEcLPkKyMQksm
  Environment:
    Type: String
    Default: prod
  DefaultBucket:
    Type: String
    Default: macro-template-default-831650818513-us-east-1

Resources:

  VirtualPrivateCloud:
    Type: Template::Git
    Properties:
      Mode: Inline
      Provider: Gitlab
      Project: !Ref ProjectName
      Branch: !Ref BranchName
      Path: !Ref TemplateVPC
      OAuthToken: !Ref GitLabToken
      Parameters:
        AccountName: 'test'
        Environment: !Ref Environment
        Owner: 'giallo'
        CentroCosti: 'aws'
        Project: !Select [ 2, !Split [ '/', !Ref ProjectName ] ]
        VpcCidr: '10.88.135.0/24'
        PrivateSubnetCidrA: '10.88.135.0/26'
        PrivateSubnetCidrB: '10.88.135.64/26'
        PublicSubnetCidrA: '10.88.135.128/26'
        PublicSubnetCidrB: '10.88.135.192/26'

  FlowLogs:
    Type: Template::Git
    DependsOn: Template::VirtualPrivateCloud
    Properties:
      Mode: Inline
      Provider: Gitlab
      Project: !Ref ProjectName
      Branch: !Ref BranchName
      Path: !Ref TemplateFlowLog
      OAuthToken: !Ref GitLabToken
      Parameters:
        Constructor: 'flowlog-test'
        VPCId: !Ref Template::VirtualPrivateCloud::VPC
        CRRDestinationBucket: !Ref DefaultBucket
        CRRDestinationAccountId: 'giallo'


